{"name":"Chancery","tagline":"Automate on Github pushes","body":"# Welcome to Chancery #\r\n\r\nChancery hears when you push to Github, and allows you to…\r\n\r\n- **Deploy when github is down!**\r\n\r\n  Chancery can send gzip'ped tarballs of your references of choice to an S3 bucket.\r\n\r\n- **Keep track of your branches history!** Even when Pierre force-pushed to `master`!\r\n\r\n  A `reflog` for Github, more or less.\r\n\r\n*Gratefully based on Java 7, Dropwizard, AWS SDK, MVEL2, Joda Time and lombok.*\r\n\r\n**Table of Contents**\r\n\r\n- [What it does](#what-it-does)\r\n- [Set it up (one-time operation)](#set-it-up-one-time-operation)\r\n    - [Prepare credentials](#prepare-credentials)\r\n        - [Github](#github)\r\n        - [AWS (only if you want S3 tarballs)](#aws-only-if-you-want-s3-tarballs)\r\n    - [Build it](#build-it)\r\n    - [Write a configuration file](#write-a-configuration-file)\r\n    - [Run it](#run-it)\r\n    - [Monitor it](#monitor-it)\r\n- [Install a web hook (needed for every repository)](#install-a-web-hook-needed-for-every-repository)\r\n- [Contribute](#contribute)\r\n    - [Local development](#local-development)\r\n\r\n## What it does ##\r\n\r\nWhenever someone updates a reference (tag, branch, etc.) in a monitored repository,\r\nGithub lets Chancery know through a web hook. If Github sent the right secret,\r\nChancery will do its magic.\r\n\r\nYou can configure a few backends, each of them have their own configuration.\r\n\r\nThey usually start by trying to match `$REPO_URI:$REF` against their `refFilter`\r\nregular expression. This provides a limited but simple way to specify which branches\r\nand/or tags of which repositories should be acted upon.\r\n\r\n- For S3 tarballs, the web hook message is passed to the `keyTemplate` template.\r\n  This template turns it into an \"object key\", which you can think of\r\n  as the path of the tarball in your bucket.\r\n\r\n  If the update deleted the reference, we delete the corresponding object;\r\n  if the update changed the commit the reference points to, we let Github\r\n  bake us a fresh gzip'ped tarball then put it there.\r\n\r\n- For ref logs, the web hook message is passed to the `refTemplate` template,\r\n  and the resulting target reference is created.\r\n\r\n**A few more things** to note before we get started:\r\n\r\n1. References are always in their canonical form:\r\n   a `v1.0` tag is `refs/tags/v1.0`,\r\n   a `feature/cleartextpasswd` branch is `refs/heads/feature/cleartextpasswd`.\r\n\r\n2. The secret mechanism relies on a SHA1 HMAC and allows secure authentication of Github.\r\n   HTTPS is however needed to hide the web hook payload from passive observers,\r\n   and for protection against replay attacks.\r\n\r\n3. Templates are all MVEL 2 string templates.\r\n   Please look at their [templating guide](http://mvel.codehaus.org/MVEL+2.0+Templating+Guide)\r\n   for the syntax.\r\n\r\n   A lot of information from the hook is usable there; please look at the sources\r\n   of `CallbackPayload` or the Chancery debug logs.\r\n\r\n   We added a `timestamp` attribute that matches when Chancery received the callback,\r\n   and Joda Time's `ISODateTimeFormat` class is exposed as `iso`, `DateTimeFormat` as `dtf`.\r\n\r\n## Set it up (one-time operation) ##\r\n\r\n### Prepare credentials ###\r\n\r\n#### Github ####\r\n\r\n1. Create an `acme-chancery` github user.\r\n\r\n2. Create an oAuth2 token for that user, keep it around:\r\n\r\n        $ curl \\\r\n            --silent --fail \\\r\n            --request POST \\\r\n            --user 'acme-chancery:password123' \\\r\n            -H 'Content-Type: application/json' \\\r\n            --data '{ \"scopes\": [\"repo\"], \"note\": \"chancery\" }' \\\r\n            https://api.github.com/authorizations\r\n        {\r\n          [...]\r\n          \"token\": \"1234567890abcdef1234567890abcdef12345678\",\r\n          [...]\r\n        }\r\n\r\n3. Give the bot access to the repositories. We suggest using a team.\r\n   \"Pull-only\" is enough for S3 tarballs, but \"Push & Pull\" is needed for reflogs.\r\n\r\n#### AWS (only if you want S3 tarballs) ####\r\n\r\n1. Create an AMI user, keep its Access Key Id and Secret Access Key around.\r\n\r\n2. Attach a user policy to it:\r\n\r\n        {\"Statement\":[{\r\n            \"Action\": [\"s3:*\"],\r\n            \"Effect\": \"Allow\",\r\n            \"Resource\": [\r\n                \"arn:aws:s3:::deployment.acme.com/repos/*\",\r\n                \"arn:aws:s3:::archive.acme.com/repos/*\"\r\n            ]\r\n        }]}\r\n\r\n### Build it ###\r\n\r\nYou'll need Java 7 and a recent version of Maven (only tested with Maven 3).\r\n\r\n    $ mvn package; ls -l target/chancery-1.0-SNAPSHOT.jar\r\n\r\n### Write a configuration file ###\r\n\r\nDropwizard comes with many options, please refer to their documentation and\r\n[commented example](https://github.com/codahale/dropwizard/blob/master/dropwizard-example/example.yml).\r\n\r\nHere is an example for our story:\r\n\r\n    # Defaults to 16\r\n    handlerThreads: 32\r\n\r\n    # Required\r\n    githubOauth2Token: 1234567890abcdef1234567890abcdef12345678\r\n    # Optional. You get to pick it, so we did:\r\n    githubSecret: 'airbnb <3 github :)'\r\n\r\n    # Required for S3 tarballs\r\n    awsAccessKeyID: XXXXXXXXXXXXXXXXXXXX\r\n    awsSecretKey: YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\r\n\r\n    s3Archives:\r\n      - refFilter:   https://github\\.com/acme/project-(manhattan|brooklyn):refs/heads/prod/.*\r\n        bucketName:  deployment.acme.com\r\n        keyTemplate: repos/@{repository.name}/@{ref}\r\n      - refFilter:   https://github\\.com/acme/.*:refs/(heads/prod|tags)/.*\r\n        bucketName:  archive.acme.com\r\n        keyTemplate: repos/@{repository.name}/@{ref}:@{timestamp}\r\n\r\n    refLogs:\r\n      - refFilter:   https://github\\.com/acme/.*:refs/(heads|tags)\r\n        refTemplate: 'refs/history/@{ref.substring(5)}/@{dtf.forPattern(\"yyyy/MM/dd/HH/mm/ss\").print(timestamp)}'\r\n\r\n    # Github can be very slow.\r\n    githubHttpConfig:\r\n      timeout: 20s\r\n      connectionTimeout: 10s\r\n      maxConnectionsPerRoute: 16\r\n      keepAlive: 60s\r\n      # Github's nginx servers require this (or you'll get 411)\r\n      gzipEnabledForRequests: false\r\n    \r\n    # Log ALL before opening an issue please\r\n    logging:\r\n      console:\r\n        enabled: true\r\n        threshold: ALL\r\n\r\n### Run it ###\r\n\r\nYou'll need Java 7, the `chancery-2.0-SNAPSHOT.jar` überjar and a configuration\r\nfile.\r\n\r\n    $  java -jar chancery-2.0-SNAPSHOT.jar server /etc/chancery.yml\r\n\r\n### Monitor it ###\r\n\r\nThe various monitoring endpoints are listed on the admin port (8081 by default).\r\n\r\nYou'll a few basic health checks in `/healthcheck` and\r\na bunch of metrics in `/metrics?pretty`;\r\nfeel free to suggest more.\r\n\r\nPlease remember that the metrics are JMX-friendly;\r\nthe Dropwizard documentation is yet again of great help.\r\n\r\n## Install a web hook (needed for every repository) ##\r\n\r\nYou'll need to create the Github web hooks with your own user, as the\r\n`acme-chancery` doesn't have sufficient rights.\r\n\r\n    $ curl \\\r\n        --silent --fail \\\r\n        --request POST \\\r\n        --user 'acme-root:god' \\\r\n        -H 'Content-Type: application/json' \\\r\n        --data '{\r\n                  \"name\": \"web\",\r\n                  \"active\": true,\r\n                  \"config\": {\r\n                    \"content_type\": \"json\",\r\n                    \"secret\": \"airbnb <3 github :)\",\r\n                    \"url\": \"https://chancery.ewr.corp.acme.com/callback\"\r\n                  }\r\n                }' \\\r\n        https://api.github.com/repos/acme/project-manhattan/hooks\r\n\r\n\r\nThen verify that the Chancery configuration file, in particular `refPattern`,\r\nmatches your particular needs.\r\n\r\n## Contribute ##\r\n\r\nOpen issues, send pull requests, share your love with\r\n[@AirbnbNerds](https://twitter.com/AirbnbNerds) on Twitter!\r\n\r\n### Code? ###\r\n\r\n1. Fork it\r\n2. Create your feature branch (`git checkout -b my-new-feature`)\r\n3. Add yourself to the contributors in `pom.xml`\r\n4. Commit your changes (`git commit -am 'Add some feature'`)\r\n5. Push to the branch (`git push origin my-new-feature`)\r\n6. Create new Pull Request\r\n\r\n### Local development ###\r\n\r\nLive-testing Github callbacks from your development machine could be a bit painful.\r\nHere is a trick.\r\n\r\n- On your publicly-accessible `server.acme.com`, make sure you allow gateway ports:\r\n\r\n        Match User johndoe\r\n            GatewayPorts yes\r\n\r\n  Restart `sshd` if needed.\r\n\r\n- From your laptop, run:\r\n\r\n        laptop$ ssh -vNR 9000:localhost:8080 server.acme.com\r\n\r\n  Note that the `9000` port needs to be reachable from the outside on\r\n  `server.acme.com`, but you do not need to open your laptop firewall as\r\n  connections will come through the loopback interface.\r\n\r\n- On your laptop, fire up a logging HTTP server, check that it receives requests:\r\n\r\n        $ python -mSimpleHTTPServer 8080 &\r\n        [1] 32430\r\n        Serving HTTP on 0.0.0.0 port 8080 ...\r\n        $ curl -sf http://server.acme.com:9000/ >/dev/null\r\n        127.0.0.1 - - [29/Apr/2013 02:08:48] \"GET / HTTP/1.1\" 200 -\r\n        $ kill %%\r\n\r\n- You can now ask Github to send callbacks to `http://server.acme.com:9000/`.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}